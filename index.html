<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sdoba Zakax Web App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Mock data with placeholder images
    const mockCategories = [
      { id: 1, name: "Слойки сытные", image: "https://placehold.co/200x200?text=Слойки" },
      { id: 2, name: "Розаны", image: "https://placehold.co/200x200?text=Розаны" },
      { id: 3, name: "Штрудели", image: "https://placehold.co/200x200?text=Штрудели" },
    ];

    const mockProducts = [
      { id: 1, category_id: 1, name: "Product 1", article: "P001", weight: 100, price_per_unit: 10.00, units_per_pack: 50, price_per_pack: 500.00, storage_period: "12 мес.", technology: "RST", available_units: 20, image: "https://placehold.co/200x200?text=Product+1" },
      { id: 2, category_id: 1, name: "Product 2", article: "P002", weight: 120, price_per_unit: 12.00, units_per_pack: 50, price_per_pack: 600.00, storage_period: "12 мес.", technology: "RST", available_units: 15, image: "https://placehold.co/200x200?text=Product+2" },
      { id: 3, category_id: 2, name: "Product 3", article: "P003", weight: 110, price_per_unit: 15.00, units_per_pack: 50, price_per_pack: 750.00, storage_period: "6 мес.", technology: "RST", available_units: 10, image: "https://placehold.co/200x200?text=Product+3" },
      { id: 4, category_id: 3, name: "Product 4", article: "P004", weight: 150, price_per_unit: 20.00, units_per_pack: 30, price_per_pack: 600.00, storage_period: "12 мес.", technology: "RST", available_units: 5, image: "https://placehold.co/200x200?text=Product+4" },
    ];

    // Breadcrumbs Component
    function Breadcrumbs({ screen, selectedCategory, selectedProduct, setScreen }) {
      const items = [{ name: "Главная", screen: "main" }];
      if (screen === "catalog") {
        items.push({ name: "Каталог", screen: "catalog" });
      } else if (screen === "products") {
        items.push({ name: "Каталог", screen: "catalog" }, { name: selectedCategory.name, screen: "products" });
      } else if (screen === "product_details") {
        items.push(
          { name: "Каталог", screen: "catalog" },
          { name: selectedCategory.name, screen: "products" },
          { name: selectedProduct.name, screen: "product_details" }
        );
      }

      return (
        <div className="flex flex-wrap items-center p-4 bg-gray-200 text-gray-700 text-sm">
          {items.map((item, index) => (
            <span key={item.name} className="flex items-center">
              {index > 0 && <span className="mx-2">></span>}
              <button
                className="hover:underline focus:outline-none"
                onClick={() => setScreen(item.screen)}
                disabled={item.screen === screen}
              >
                {item.name}
              </button>
            </span>
          ))}
        </div>
      );
    }

    // Main App Component
    function App() {
      const [screen, setScreen] = useState("main");
      const [selectedCategory, setSelectedCategory] = useState(null);
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [cart, setCart] = useState([]);
      const [quantity, setQuantity] = useState(1);
      const [checkoutData, setCheckoutData] = useState({ name: "", phone: "", address: "" });
      const [orders, setOrders] = useState([]);

      useEffect(() => {
        // Initialize Telegram Web App
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        // Set up MainButton based on screen
        Telegram.WebApp.MainButton.hide();
        if (screen === "cart" && cart.length > 0) {
          Telegram.WebApp.MainButton.setText("Оформить заказ");
          Telegram.WebApp.MainButton.show();
          Telegram.WebApp.MainButton.onClick(() => setScreen("checkout"));
        } else if (screen === "checkout") {
          Telegram.WebApp.MainButton.setText("Отправить заказ");
          Telegram.WebApp.MainButton.show();
          Telegram.WebApp.MainButton.onClick(handleCheckout);
        } else if (screen === "product_details") {
          Telegram.WebApp.MainButton.setText("Добавить в корзину");
          Telegram.WebApp.MainButton.show();
          Telegram.WebApp.MainButton.onClick(() => handleAddToCart(selectedProduct, false));
        }
      }, [screen, cart, selectedProduct]);

      const handleAddToCart = (product, isPack = false) => {
        if (quantity < 1 || quantity > product.available_units) {
          Telegram.WebApp.showAlert(`Недопустимое количество. Доступно: ${product.available_units} шт.`);
          return;
        }
        setCart([...cart, { ...product, isPack, quantity }]);
        Telegram.WebApp.showAlert(`Добавлено: ${product.name} (${isPack ? "упаковка" : "поштучно"}, ${quantity} шт.)`);
        setQuantity(1); // Reset quantity
      };

      const handleCheckout = () => {
        if (!checkoutData.name || !checkoutData.phone || !checkoutData.address) {
          Telegram.WebApp.showAlert("Пожалуйста, заполните все поля.");
          return;
        }
        const order = {
          id: orders.length + 1,
          user_id: Telegram.WebApp.initDataUnsafe.user?.id || 0,
          total_price: cart.reduce((sum, item) => sum + (item.isPack ? item.price_per_pack : item.price_per_unit) * item.quantity, 0),
          items: cart,
          created_at: new Date().toISOString(),
        };
        setOrders([...orders, order]);
        setCart([]);
        setCheckoutData({ name: "", phone: "", address: "" });
        Telegram.WebApp.showAlert("Заказ успешно отправлен!");
        setScreen("main");
      };

      const renderMainMenu = () => (
        <div className="p-6">
          <h1 className="text-3xl font-bold text-center mb-6">Sdoba Zakax</h1>
          <div className="grid grid-cols-1 gap-4">
            <button
              className="bg-orange-300 text-white rounded-xl p-4 shadow-md hover:bg-orange-600 transition-colors"
              onClick={() => setScreen("catalogue")}
            >
              Каталог
            </button>
            <button
              className="bg-orange-300 text-white rounded-xl p-4 shadow-md hover:bg-orange-600 transition-colors"
              onClick={() => setScreen("cart")}
            >
              Корзина ({cart.length})
            </button>
            <button
              className="bg-orange-300 text-white rounded-xl p-4 shadow-md hover:bg-orange-600 transition-colors"
              onClick={() => setScreen("history")}
            >
              История заказов
            </button>
          </div>
        </div>
      );

      const renderCatalog = () => (
        <div>
          <Breadcrumbs screen={screen} setScreen={setScreen} />
          <div className="p-6">
            <h2 className="text-2xl font-semibold mb-4 text-center">Категории</h2>
            <div className="grid grid-cols-2 gap-4">
              {mockCategories.map((category) => (
                <div
                  key={category.id}
                  className="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow"
                  onClick={() => {
                    setSelectedCategory(category);
                    setScreen("products");
                  }}
                >
                  <img src={category.image} alt={category.name} className="w-full h-40 object-cover" />
                  <div className="p-3 text-center">
                    <h3 className="text-lg font-medium">{category.name}</h3>
                  </div>
                </div>
              ))}
            </div>
            <button
              className="w-full bg-orange-300 text-white rounded-xl p-3 mt-6 hover:bg-orange-600 transition-colors"
              onClick={() => setScreen("mainMenu")}
            >
              Назад
            </button>
          </div>
        </div>
      );

      const renderProducts = () => (
        <div>
          <Breadcrumbs
            screen={screen}
            selectedCategory={selectedCategory}
            setScreen={setScreen}
          />
          <div className="p-6">
            <h2 className="text-2xl font-semibold mb-4 text-center">{selectedCategory.name}</h2>
            <div className="grid grid-cols-2 gap-4">
              {mock_products
                .filter((product) => product.category_id === selectedCategory.id)
                .map((product) => (
                  <div
                    key={product.id}
                    className="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow"
                    onClick={() => {
                      setSelectedProduct(product);
                      setScreen("product_details");
                    }}
                  >
                    <img src={product.image} alt={product.name} className="w-full h-40 object-cover" />
                    <div className="p-3 text-center">
                      <h3 className="text-lg font-medium">{product.name}</h3>
                      <p className="text-gray-600">{product.price_per_unit}₽/шт.</p>
                      <p className="text-sm text-gray-500">Доступно: {product.available_units} шт.</p>
                    </div>
                  </div>
                ))}
            </div>
            <button
              className="w-full bg-orange-300 text-white rounded-xl p-3 mt-6 hover:bg-orange-600 transition-colors"
              onClick={() => setScreen("catalogue")}
            >
              Назад
            </button>
          </div>
        </div>
      );

      const renderProductDetails = () => (
        <div>
          <Breadcrumbs
            screen={screen}
            selectedCategory={selectedCategory}
            selectedProduct={selectedProduct}
            setScreen={setScreen}
          />
          <div className="p-6">
            <img src={selectedProduct.image} alt={selectedProduct.name} className="w-full h-64 object-cover rounded-lg mb-4" />
            <h2 className="text-2xl font-semibold mb-4">{selectedProduct.name}</h2>
            <p className="text-gray-700 mb-2">Артикул: {selectedProduct.article}</p>
            <p className="text-gray-700 mb-2">Вес: {selectedProduct.weight} г</p>
            <p className="text-gray-700 mb-2">Цена за шт.: {selectedProduct.price_per_unit}₽</p>
            <p className="text-gray-700 mb-2">Цена за упаковку ({selectedProduct.units_per_pack} шт.): {selectedProduct.price_per_pack}₽</p>
            <p className="text-gray-700 mb-2">Срок хранения: {selectedProduct.storage_period}</p>
            <p className="text-gray-700 mb-4">Технология: {selectedProduct.technology}</p>
            <p className="text-gray-700 mb-4">Доступно: {selectedProduct.available_units} шт.</p>
            <div className="mb-4">
              <label className="block text-gray-700 mb-2">Количество:</label>
              <input
                type="number"
                min="1"
                max={selectedProduct.available_units}
                value={quantity}
                onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                className="w-20 p-2 border rounded-lg"
              />
            </div>
            <div className="flex space-x-4 mb-6">
              <button
                className="flex-1 bg-orange-300 text-white rounded-xl p-3 hover:bg-orange-600 transition-colors"
                onClick={() => handleAddToCart(selectedProduct, false)}
              >
                Поштучно
              </button>
              <button
                className="flex-1 bg-orange-300 text-white rounded-xl p-3 hover:bg-orange-600 transition-colors"
                onClick={() => handleAddToCart(selectedProduct, true)}
              >
                Упаковкой
              </button>
            </div>
            <button
              className="w-full bg-orange-300 text-white rounded-xl p-3 hover:bg-orange-600 transition-colors"
              onClick={() => setScreen("products")}
            >
              Назад
            </button>
          </div>
        </div>
      );

      const renderCart = () => (
        <div className="p-6">
          <h2 className="text-2xl font-semibold mb-4 text-center">Корзина</h2>
          {cart.length === 0 ? (
            <p className="text-center text-gray-600">Ваша корзина пуста.</p>
          ) : (
            <>
              {cart.map((item, index) => (
                <div key={index} className="bg-white rounded-lg shadow-md p-4 mb-4">
                  <div className="flex items-center">
                    <img src={item.image} alt={item.name} className="w-16 h-16 object-cover rounded-lg mr-4" />
                    <div>
                      <p className="font-medium">{item.name}</p>
                      <p className="text-gray-600">{item.quantity} {item.isPack ? "упаковок" : "шт."}</p>
                      <p className="text-gray-600">Цена: {(item.isPack ? item.price_per_pack : item.price_per_unit) * item.quantity}₽</p>
                    </div>
                  </div>
                </div>
              ))}
              <p className="text-xl font-bold text-center mb-4">
                Итого: {cart.reduce((sum, item) => sum + (item.isPack ? item.price_per_pack : item.price_per_unit) * item.quantity, 0)}₽
              </p>
              <button
                className="w-full bg-orange-300 text-white rounded-xl p-3 mb-4 hover:bg-orange-600 transition-colors"
                onClick={() => setCart([])}
              >
                Очистить корзину
              </button>
            </>
          )}
          <button
            className="w-full bg-orange-300 text-white rounded-xl p-3 hover:bg-orange-600 transition-colors"
            onClick={() => setScreen("mainMenu")}
          >
            Назад
          </button>
        </div>
      );

      const renderCheckout = () => (
        <div className="p-6">
          <h2 className="text-2xl font-semibold mb-4 text-center">Оформление заказа</h2>
          <input
            type="text"
            placeholder="Имя"
            className="w-full p-3 mb-4 border rounded-lg"
            value={checkoutData.name}
            onChange={(e) => setCheckoutData({ ...checkoutData, name: e.target.value })}
          />
          <input
            type="text"
            placeholder="Телефон"
            className="w-full p-3 mb-4 border rounded-lg"
            value={checkoutData.phone}
            onChange={(e) => setCheckoutData({ ...checkoutData, phone: e.target.value })}
          />
          <input
            type="text"
            placeholder="Адрес"
            className="w-full p-3 mb-4 border rounded-lg"
            value={checkoutData.address}
            onChange={(e) => setCheckoutData({ ...checkoutData, address: e.target.value })}
          />
          <button
            className="w-full bg-orange-300 text-white rounded-xl p-3 hover:bg-orange-600 transition-colors"
            onClick={() => setScreen("cart")}
          >
            Назад
          </button>
        </div>
      );

      const renderHistory = () => (
        <div className="p-6">
          <h2 className="text-2xl font-semibold mb-4 text-center">История заказов</h2>
          {orders.length === 0 ? (
            <p className="text-center text-gray-600">У вас пока нет заказов.</p>
          ) : (
            orders.map((order) => (
              <div key={order.id} className="bg-white rounded-lg shadow-md p-4 mb-4">
                <p className="font-medium">Заказ #{order.id} ({new Date(order.created_at).toLocaleString()})</p>
                <p className="text-gray-600">Итого: {order.total_price}₽</p>
                {order.items.map((item, index) => (
                  <div key={index} className="flex items-center mt-2">
                    <img src={item.image} alt={item.name} className="w-12 h-12 object-cover rounded-lg mr-3" />
                    <p className="text-gray-600">- {item.name} - {item.quantity} {item.isPack ? "упаковок" : "шт."}</p>
                  </div>
                ))}
              </div>
            ))
          )}
          <button
            className="w-full bg-orange-300 text-white rounded-xl p-3 hover:bg-orange-600 transition-colors"
            onClick={() => setScreen("mainMenu")}
          >
            Назад
          </button>
        </div>
      );

      return (
        <div className="min-h-screen bg-gray-100">
          {screen === "mainMenu" && renderMainMenu()}
          {screen === "catalogue" && renderCatalog()}
          {screen === "products" && renderProducts()}
          {screen === "product_details" && renderProductDetails()}
          {screen === "cart" && renderCart()}
          {screen === "checkout" && renderCheckout()}
          {screen === "history" && renderHistory()}
        </div>
      );
    }

    // Render the app
    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
